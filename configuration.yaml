# vim: set expandtab tabstop=2 shiftwidth=2 softtabstop=2:

homeassistant:
  # Name of the location where Home Assistant is running
  name: Home
  # Location required to calculate the time the sun rises and sets
  latitude: !secret home_latitude
  longitude: !secret home_longitude
  # Impacts weather/sunrise data (altitude above sea level in meters)
  elevation: 7
  # metric for Metric, imperial for Imperial
  unit_system: metric
  # Pick yours from here: http://en.wikipedia.org/wiki/List_of_tz_database_time_zones
  time_zone: America/Halifax
  # Allow homeassistant to write to snapshots dir
  allowlist_external_dirs:
    - /var/www/html/snapshots
    - /etc/homeassistant/file_restore
  media_dirs:
    security: /var/www/html/snapshots
  customize: !include customize.yaml

default_config:

# {{{ Alexa

alexa:
  smart_home:
    endpoint: https://api.amazonalexa.com/v3/events
    client_id: !secret alexa_client_id
    client_secret: !secret alexa_client_secret
    filter:
      include_domains:
        - light
        - scene
      include_entities:
        - media_player.roku_3
        - media_player.roku_bedroomtv
        - media_player.roku_living_roomtv
        - media_player.sonos
        - switch.switch1
        - switch.switch6
        - switch.switch7
        - switch.switch8

# }}}
# {{{ mqtt switch

#switch:
#  - platform: mqtt
#    name: "Zigbee2mqtt Main join"
#    state_topic: "zigbee2mqtt/bridge/config/permit_join"
#    command_topic: "zigbee2mqtt/bridge/config/permit_join"
#    payload_on: "true"
#    payload_off: "false"

# }}}
# {{{ frontend

# Enables the frontend
frontend:
  themes: !include_dir_merge_named themes/

http:
  #ssl_certificate: !secret http_ssl_certificate
  #ssl_key: !secret http_ssl_key
  use_x_forwarded_for: true
  trusted_proxies:
    - 127.0.0.1

# }}}
# {{{ Lights

light:
  # Make Barn switches act like lights
  - platform: switch
    name: Barn Light
    entity_id: switch.barn

  - platform: switch
    name: Barn Tree0
    entity_id: switch.switch3

  - platform: switch
    name: Barn Tree1
    entity_id: switch.switch4

  # Make Bathroom switches act like lights
  - platform: switch
    name: Bathroom0
    entity_id: switch.bathroom0
  - platform: switch
    name: Bathroom1
    entity_id: switch.bathroom1

  # Make Dining Room switch act like a light
  - platform: switch
    name: Dining room table
    entity_id: switch.switch6

  # Make Entryway switch act like a light
  - platform: switch
    name: Entryway
    entity_id: switch.entryway

  # Make Garage switches act like lights
  - platform: switch
    name: Garage Eaves
    entity_id: switch.garage_eaves

  # Make Livingroom switches act like a lights
  - platform: switch
    name: Livingroom Table
    entity_id: switch.switch0
  - platform: switch
    name: Saltlick
    entity_id: switch.switch5

  # Make Pantry switches act like lights
  - platform: switch
    name: Pantry Counter
    entity_id: switch.switch2

  # Make Porch switch act like a light
  - platform: switch
    name: Porch Lights
    entity_id: switch.porch

  # Light Groups
  - platform: group
    name: Barn lights
    entities:
      - light.barn
      - light.barn0
      - light.barn_trees

  - platform: group
    name: Barn trees
    entities:
      - light.barn_tree0
      - light.barn_tree1

  - platform: group
    name: Basement lights
    entities:
      - light.basement0

  - platform: group
    name: Bathroom lights
    entities:
      - light.bathroom0
      - light.bathroom1
      - light.bathroom_sink

  - platform: group
    name: Bathroom sink
    entities:
      - light.sink0
      - light.sink1
      - light.sink2

  - platform: group
    name: Bedroom ceiling
    entities:
      - light.bedroom4
      - light.bedroom5
      - light.bedroom6

  - platform: group
    name: Bedroom lamps
    entities:
      - light.bedroom2
      - light.bedroom3

  - platform: group
    name: Bedroom wall
    entities:
      - light.bedroom0
      - light.bedroom1

  - platform: group
    name: Bedroom lights
    entities:
      - light.bedroom_ceiling
      - light.bedroom_lamps
      - light.bedroom_wall

  - platform: group
    name: Dining room lights
    entities:
      - light.diningroom0
      - light.diningroom1
      - light.diningroom2
      - light.diningroom3
      - light.diningroom4
      - light.dining_room_table

  - platform: group
    name: Garage lights
    entities:
      - light.garage_eaves
      - light.garage_pots

  # {{{ Hallway lights
  - platform: group
    name: Foyer Lights
    entities:
      - light.foyer0
      - light.foyer1
      - light.foyer2
      - light.foyer3
      - light.foyer4

  - platform: group
    name: Hallway Back Lights
    entities:
      - light.hall_back0
      - light.hall_back1

  - platform: group
    name: Downstairs Hall Lights
    entities:
      - light.hallway0
      - light.hallway1
      - light.hallway2

  - platform: group
    name: Upstairs Hall Lights
    entities:
      - light.hall_up0
      - light.hall_up1
      - light.hall_up2

  - platform: group
    name: Hallway lights
    entities:
      - light.entryway
      - light.foyer_lights
      - light.hallway_back_lights
      - light.downstairs_hall_lights
      - light.upstairs_hall_lights

  # }}}

  - platform: group
    name: Laundry Room Lights
    entities:
      - light.laundry_room
      - light.laundry_room_lamp

  - platform: group
    name: Livingroom lamps
    entities:
      - light.lamp0
      - light.lamp1
      - light.lamp2

  - platform: group
    name: Livingroom lights
    entities:
      - light.livingroom_lamps
      - light.livingroom_table
      - light.saltlick

  - platform: group
    name: Kitchen lights
    entities:
      - light.cabinets_lower
      - light.cabinets_upper
      - light.kitchen_island
      - light.kitchen_pots
      - light.kitchen_sink
      - light.kitchen_table

  - platform: group
    name: Main floor lights
    entities:
      - light.barn_lights
      - light.dining_room_lights
      - light.downstairs_hall_lights
      - light.entryway
      - light.foyer_lights
      - light.kitchen_lights
      - light.laundry_room_lights
      - light.livingroom_lights
      - light.pantry_lights

  - platform: group
    name: Office lights
    entities:
      - light.office0

  - platform: group
    name: Outdoor lights
    entities:
      - light.front_door
      - light.garage_eaves
      - light.porch_lights

  - platform: group
    name: Pantry lights
    entities:
      - light.pantry_counter
      - light.pantry

  - platform: group
    name: Second floor lights
    entities:
      - light.bathroom_lights
      - light.bedroom_lights
      - light.hallway_back_lights
      - light.upstairs_hall_lights
      - light.office_lights
      - light.spare_room_lights

  - platform: group
    name: Spare room lights
    entities:
      - light.spare0
      - light.spare1
      - light.spare2

#  }}}
# {{{ Media Players

media_player:

# }}}
# {{{ Misc

# Enable frontend configuration
config:

# Discover some devices automatically
discovery:

# Set logging level
logger:
  default: error
  logs:
    homeassistant.components.camera: fatal
    homeassistant.components.media_player.roku: fatal
    homeassistant.components.http.ban: warning
    homeassistant.components.wemo: fatal

# Homekit
homekit:
  filter:
    include_domains:
      - light
      - media_player
      - switch

# Lutron Caseta
lutron_caseta:
  host: 192.168.2.121
  keyfile:  '/etc/homeassistant/lutron/caseta.key'
  certfile: '/etc/homeassistant/lutron/caseta.crt'
  ca_certs: '/etc/homeassistant/lutron/caseta-bridge.crt'

# Enables support for tracking state changes over time.
history:
  include:
    domains:
      - light
    entities:
      - person.gail
      - person.gervais
      - person.jennifer

# Setup recorder and logbook
recorder:
  db_url: !secret db_url
logbook:
  exclude:
    domains:
      - device_tracker
      - sun

image:

# Track the sun
sun:

ifttt:
  key: !secret ifttt_key

ffmpeg:
  ffmpeg_bin: /usr/bin/ffmpeg

# Enable Mobile App component
mobile_app:

system_health:

# }}}
# {{{ mqtt

timer:
  zigbee_permit_join:
    name: Time remaining
    duration: 120

# Input select for Zigbee2mqtt debug level
input_select:
  zigbee2mqtt_log_level:
    name: Zigbee2mqtt Log Level
    options:
      - debug
      - info
      - warn
      - error
    initial: info
    icon: mdi:format-list-bulleted

# Input text to input Zigbee2mqtt friendly_name for scripts
input_text:
  zigbee2mqtt_old_name:
    name: Zigbee2mqtt Old Name
  zigbee2mqtt_new_name:
    name: Zigbee2mqtt New Name
  zigbee2mqtt_remove:
    name: Zigbee2mqtt Remove

# }}}
# {{{ Notify

notify:
  - name: zulip
    platform: rest
    resource: !secret zulip_notify_resource
    method: POST_JSON
    title_param_name: topic

  - name: ecobee
    platform: ecobee

# }}}
# {{{ Persons

person:
  - name: Gail
    id: gail1968
    user_id: 09f60884ba844227a9b3c2d54fb341e2
    device_trackers:
      - device_tracker.gail_iphone
      - device_tracker.gail3
  - name: Cameron
    id: cam1995
    device_trackers:
      - device_tracker.camphone
      - device_tracker.cam_fing
  - name: Grant
    id: grant1994
    device_trackers:
      - device_tracker.grantphone
      - device_tracker.grant_fing
  - name: Jennifer
    id: jen2000
    user_id: 10f174a6c6db401babe419a388e8eaa8
    device_trackers:
      - device_tracker.jen_phone
      - device_tracker.jen_fing
      - device_tracker.jennifersiphone
      - device_tracker.jennifer_iphone_detect3
      - device_tracker.jennifersiphone_4

# }}}
# {{{ Presence Trackers

device_tracker:
  - platform: ping
    count: 3
    hosts:
      bell_internet: 1.1.1.1

  - platform: iphonedetect
    consider_home: 600
    new_device_defaults:
      track_new_devices: true
    hosts:
      jennifer_iphone_detect: 192.168.2.64
      jennifer_iphone_detect2: 192.168.2.10
      jennifer_iphone_detect3: 192.168.2.152

# }}}
# {{{ Programmable thermostat

climate:
  - platform: programmable_thermostat
    name: Bedroom Heater
    heater:
      - switch.switch8
    actual_temp_sensor: sensor.master_bedroom_temperature
    min_temp: 14
    max_temp: 22
    target_temp_sensor: sensor.thermostat_program
    tolerance: 0.3
    hvac_options: 7
    auto_mode: all

    #- platform: programmable_thermostat
    #- name: Dressing Room Heater
    #- heater:
    #-   - switch.switch9
    #- actual_temp_sensor: sensor.instance02_ble_temperature_dressing_room
    #- min_temp: 14
    #- max_temp: 26
    #- target_temp_sensor: sensor.thermostat_dressing_program
    #- tolerance: 0.3
    #- hvac_options: 7
    #- auto_mode: all

  - platform: programmable_thermostat
    name: Jenroom Heater
    heater:
      - switch.switch7
    actual_temp_sensor: sensor.jennifer_room_temperature
    min_temp: 14
    max_temp: 22
    target_temp_sensor: sensor.thermostat_jen_program
    tolerance: 0.3
    hvac_options: 7
    auto_mode: all

# }}}
## {{{ Rest Commands

rest_command:
  sabnzb_api:
    url: !secret sabnzbd_rest_url

## }}}
# {{{ Security Cams

camera:
  - platform: mjpeg
    mjpeg_url: http://pi3:8081
    name: Garage Live cam

# }}}
# {{{ Sensors

sensor:
  - platform: cert_expiry
    host: !secret http_base_url

  - platform: systemmonitor
    resources:
      - type: disk_use_percent
        arg: /
      - type: disk_use_percent
        arg: /boot
      - type: disk_use_percent
        arg: /media/wine
      - type: disk_use_percent
        arg: /home
      - type: memory_use_percent
      - type: swap_use_percent
      - type: load_1m
      - type: load_5m
      - type: load_15m
      - type: processor_use
      - type: last_boot

  # Data for programmable thermostats
  - platform: file_restore
    unit_of_measurement: '°C'
    file_path: '/etc/homeassistant/file_restore/thermostat_program.csv'
    name: Thermostat Program
    length: day
    detail: hour

  - platform: file_restore
    unit_of_measurement: '°C'
    file_path: '/etc/homeassistant/file_restore/thermostat_dressing_program.csv'
    name: Thermostat Dressing Program
    length: week
    detail: day

  - platform: file_restore
    unit_of_measurement: '°C'
    file_path: '/etc/homeassistant/file_restore/thermostat_jen_program.csv'
    name: Thermostat Jen Program
    length: day
    detail: hour

  - platform: template
    sensors:
      kitchen_lumens:
        friendly_name: 'Kitchen Lumens'
        value_template: '{{ states.sensor.kitchen_sensor_light_level.attributes.lightlevel }}'
        unit_of_measurement: Lumens
        device_class: illuminance

      spare_room_lumens:
        friendly_name: 'Spare Room Lumens'
        value_template: '{{ states.sensor.spare_room_sensor_light_level.attributes.lightlevel }}'
        unit_of_measurement: Lumens
        device_class: illuminance

      sun_room_lumens:
        friendly_name: 'Sun Room Lumens'
        value_template: '{{ states.sensor.sun_room_sensor_light_level.attributes.lightlevel }}'
        unit_of_measurement: Lumens
        device_class: illuminance

      distance_apart:
        friendly_name: 'GandG Apart'
        value_template: >-
          {% if distance(states.device_tracker.iphone, states.device_tracker.gail_iphone) | int == 0 %}
            0
          {% elif distance(states.device_tracker.iphone, states.device_tracker.gail_iphone) | round(2) < 0.09 %}
            0
          {% else %}
            {{ distance(states.device_tracker.iphone, states.device_tracker.gail_iphone) | round(2) }}
          {% endif %}
        unit_of_measurement: 'km'

  - platform: imap_email_content
    name: Fing State
    server: !secret fing_email_server
    port: 993
    username: !secret fing_email_username
    password: !secret fing_email_password
    senders:
      - alert@fing.io
      - alert@fing.com

#  # Sensor for monitoring the bridge state
#  - platform: mqtt
#    name: Zigbee2mqtt Bridge state
#    state_topic: "zigbee2mqtt/bridge/state"
#    icon: mdi:router-wireless
#  # Sensor for Showing the Zigbee2mqtt Version
#  - platform: mqtt
#    name: Zigbee2mqtt Version
#    state_topic: "zigbee2mqtt/bridge/config"
#    value_template: "{{ value_json.version }}"
#    icon: mdi:zigbee
#  # Sensor for Showing the Coordinator Version
#  - platform: mqtt
#    name: Coordinator Version
#    state_topic: "zigbee2mqtt/bridge/config"
#    value_template: "{{ value_json.coordinator }}"
#    icon: mdi:chip

  - platform: fail2ban
    jails:
      - hass-iptables
      - nginx-http-auth
      - sshd
    file_path: /var/log/fail2ban.log

binary_sensor:
  - platform: workday
    country: CA
    province: PE

  - platform: ffmpeg_motion
    name: Garage Motion
    input: http://pi3:8081
    reset: 20

# }}}
# {{{ Switches

# Wemo switches are not always being discovered automatically.
wemo:
  discovery: false
  static:
    - 192.168.20.80
    - 192.168.20.82
    - 192.168.20.83

# }}}
# {{{ Text-to-speech
tts:
  - platform: google_translate
    service_name: google_say

  - platform: voicerss
    api_key: !secret voicerss_api_key

# }}}

group: !include groups.yaml
scene: !include scenes.yaml
automation: !include automations.yaml
script: !include scripts.yaml
